\documentclass[tikz,crop]{standalone}
\input{preamble/tikz_standalone.tex}
\input{preamble/tikz_colors.tex}
\input{preamble/tikz_common.tex}
\input{preamble/tikz_style.tex}
\input{../preamble/abbreviations.tex}

\begin{document}
\begin{tikzpicture}
    \graph[
    tree layout,
    level distance=10ex,
    nodes={with struts, random variable, latent}, edges={edge, directed},
    component direction=right,
    component align=center,
    component sep=1.5em,
    ] {
    {
    M/$\rv{m}^a_d$[variational] --[draw=none] P/$\rv{m}^f_d$[variational] --[draw=none] Q/$\rv{m}^g_d$[variational],
    X/$\rv{X}_d$[observed] -> A/$\rv{a}_d$ -> F/$\rv{f}_d$ -> G/$\rv{g}_d$ -> Y/$\rv{y}_d$[observed],
    Us/""[plate] //[
    tree layout,
    component direction=down, component sep=.5ex,
    nodes={latent},
    ] {U1/$\rv{w}_1$, U2/\rvdots[draw=none, fill=none], U3/$\rv{w}_R$},
    Xp/$\rv{X}_{d^\prime}$[observed] -> Ap/$\rv{a}_{d^\prime}$ -> Fp/$\rv{f}_{d^\prime}$ -> Gp/$\rv{g}_{d^\prime}$ -> Yp/$\rv{y}_{d^\prime}$[observed],
Mp/$\rv{m}_{d^\prime}^a$[variational] --[draw=none] Pp/$\rv{m}_{d^\prime}^f$[variational] --[draw=none] Qp/$\rv{m}_{d^\prime}^g$[variational],
    };
    };

    \draw[edge, directed] (Us) -- (F);
    \draw[edge, directed] (Us) -- (Fp);

    \draw[edge, directed] (M) -- (A);
    \draw[edge, directed] (P) -- (F);
    \draw[edge, directed] (Q) -- (G);
    \draw[edge, directed] (Mp) -- (Ap);
    \draw[edge, directed] (Pp) -- (Fp);
    \draw[edge, directed] (Qp) -- (Gp);
\end{tikzpicture}
\end{document}
